import{a}from"./chunk-24DMSAFT.js";import{G as p}from"./chunk-ZMFSGBQT.js";import{Xd as d,aa as c,fa as f,ra as o}from"./chunk-S3YUDFSI.js";var h=(function(r){return r[r.fsnRefresh=0]="fsnRefresh",r[r.fsnRefreshChilds=1]="fsnRefreshChilds",r})(h||{}),x=(()=>{class r{constructor(){this.foldersChange=new o,this.tracksChange=new o,this.queue=[],this.jam=f(d),this.notify=f(p)}notifyTrackChange(e){this.tracksChange.emit({id:e})}notifyFolderChange(e,t){this.foldersChange.emit({id:e,mode:t})}waitForQueueResult(e,t,n,i,u){let s=this.queue.find(m=>m.id===t.id);if(!s&&this.current?.id===t.id&&(s=this.current),s?.notifyAfter)return this.appendToExistingWaiter(s,n,i,u),s.notifyAfter;let l=new o;return this.queue.push({title:e,id:t.id,item:t,folderIDs:n,refreshChildsFolderIDs:i,trackIDs:u,count:1,notifyAfter:l}),this.nextPoll(),l}appendToExistingWaiter(e,t,n,i){this.appendIds(e,"folderIDs",t),this.appendIds(e,"refreshChildsFolderIDs",n),this.appendIds(e,"trackIDs",i),e.count++}appendIds(e,t,n){if(n){e[t]=e[t]??[];for(let i of n)e[t].includes(i)||e[t].push(i)}}nextPoll(){this.current||(this.current=this.queue.shift(),this.current&&new a((t,n)=>{this.jam.admin.queueId({id:t.id}).then(i=>{if(t.item=i,i.error||i.done!==void 0){i.error&&this.notify.error(new Error(i.error)),this.pollEnd(t,i),n(!1);return}n(!0)}).catch(i=>{console.error("error while polling admin change queue status",i),this.pollEnd(t),n(!1)})}).poll(this.current,!0))}pollEnd(e,t){for(let n of e.folderIDs??[])this.notifyFolderChange(n,h.fsnRefresh);for(let n of e.refreshChildsFolderIDs??[])this.notifyFolderChange(n,h.fsnRefreshChilds);for(let n of e.trackIDs??[])this.notifyTrackChange(n);e.notifyAfter&&(e.notifyAfter.emit(t),e.notifyAfter.complete(),e.notifyAfter=void 0),this.current=void 0,this.nextPoll()}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{h as a,x as b};
