import{a as ee,b as te}from"./chunk-JNPRJ3MQ.js";import{a as W}from"./chunk-UPKF4LSO.js";import{a as H}from"./chunk-K7RVMPTP.js";import{a as Y,b as Z}from"./chunk-BNP52TDG.js";import{G as J,j as Q,m as C,n as U,p as q}from"./chunk-ZVKVGF76.js";import{$d as X,Cc as z,Hb as w,Ib as T,Ic as y,Lc as k,Nb as u,Ob as s,Pb as a,Qb as m,Ub as b,Uc as B,Vb as L,Vc as K,Wc as G,Wd as f,Y as P,_b as I,ab as l,ac as D,dc as g,fc as c,ia as x,k as S,na as p,nb as F,nc as R,oa as _,oc as V,qc as E,rc as $,sb as N,sc as O,tc as M,uc as A,vc as j}from"./chunk-H2EXZDP6.js";function oe(o,r){o&1&&m(0,"i",10)}function re(o,r){if(o&1&&(m(0,"i"),y(1,"stringToggle")),o&2){let n=c().$implicit;O(k(1,2,n.expanded,"icon-minus","icon-plus"))}}function de(o,r){if(o&1){let n=I();b(0),s(1,"div",8),g("click",function(){let t=p(n).$implicit,i=c();return _(i.selectNode(t))})("keydown.arrowLeft",function(){let t=p(n).$implicit,i=c();return _(i.toggleNode(t))})("keydown.arrowRight",function(){let t=p(n).$implicit,i=c();return _(i.toggleNode(t))})("keydown.enter",function(){let t=p(n).$implicit,i=c();return _(i.selectNode(t))}),s(2,"span",9),g("clickenter",function(){let t=p(n).$implicit,i=c();return _(i.toggleNode(t))}),w(3,oe,1,0,"i",10),w(4,re,2,6,"i",11),a(),s(5,"span",12),g("clickenter",function(){let t=p(n).$implicit,i=c();return _(i.toggleNode(t))}),m(6,"i"),y(7,"stringToggle"),a(),s(8,"span",13),M(9),a(),s(10,"span",14),M(11),a()(),L()}if(o&2){let n=r.$implicit,e=c();l(),E("padding-left",n.level*12,"px"),$("active",n===e.selected),l(),u("title",z("Subfolders: ",n.folder.folderCount)),l(),T(n.isLoading?3:-1),l(),T(!n.isLoading&&n.hasChildren?4:-1),l(),E("color",n.color),u("title",n.folder.type),l(),O(k(7,16,n.expanded,"icon-folder-open","icon-folder")),l(2),u("title",n.folder.name),l(),A(n.folder.name),l(2),j("| ",n.folder.type)}}function ie(o,r){if(o.children)for(let n of o.children)r(n),ie(n,r)}var ve=(()=>{let r=class r{constructor(){this.autoSelect=K(!1),this.selectionChange=B(),this.nodes=[],this.expandIDs=[],this.viewport=G(C),this.unsubscribe=new S,this.jam=x(X),this.notify=x(J),this.folderService=x(te)}ngOnInit(){this.folderService.foldersChange.pipe(P(this.unsubscribe)).subscribe(e=>{let t=this.nodes.find(i=>i.folder.id===e.id);t&&this.jam.folder.id({id:e.id,folderIncTrackCount:!0,folderIncChildFolderCount:!0}).then(i=>{t.folder=i,e.mode===ee.fsnRefreshChilds&&t.expanded&&(this.collapseNode(t),t.hasChildren=(i.folderCount??0)>0,t.children=void 0,t.isLoading=!1,t.hasChildren&&(t.expanded=!0,this.checkLoadExpanded(t)))}).catch(i=>{console.error(i)})})}ngOnDestroy(){this.unsubscribe.next(),this.unsubscribe.complete()}selectNode(e){this.selectionChange.emit(e.folder),this.autoSelect()&&(this.selected=e)}toggleNode(e){e.expanded?this.collapseNode(e):this.expandNode(e)}refresh(){this.jam.auth.isLoggedIn()&&this.jam.folder.search({level:0,folderIncChildFolderCount:!0,folderIncTrackCount:!0}).then(e=>{this.nodes=e.items.map(t=>({folder:t,hasChildren:(t.folderCount??0)>0,level:0,color:this.typeToColor(t),expanded:this.expandIDs.includes(t.id),isLoading:!1}));for(let t of this.nodes)this.checkLoadExpanded(t)}).catch(e=>{this.notify.error(e)})}typeToColor(e){switch(e.type){case f.unknown:return"#ff9fAA";case f.artist:return"#6f806e";case f.collection:return"#adbced";case f.album:return"#bdbd9c";case f.multialbum:return"#bdaaae";case f.extras:return"#bdbdbd";default:return""}}onFolderUpdate(e){let t=this.nodes.find(i=>i.folder.id===e.id);t&&(t.folder=e)}selectFolderByID(e){let t=this.nodes.find(i=>i.folder.id===e);t?this.selected=t:this.jam.folder.id({id:e,folderIncParents:!0}).then(i=>{if(i.parents){for(let d of i.parents)this.expandIDs.includes(d.id)||this.expandIDs.push(d.id);for(let d of this.nodes)d.expanded=this.expandIDs.includes(d.folder.id),this.checkLoadExpanded(d,e)}}).catch(i=>{this.notify.error(i)})}checkLoadExpanded(e,t){if(e.expanded&&!e.isLoading&&this.loadChildren(e,i=>{for(let d of i)this.checkLoadExpanded(d,t)}),e.folder.id===t){this.selected=e;let i=this.viewport();i&&i.scrollToIndex(this.nodes.indexOf(e))}}loadChildren(e,t){e.isLoading||(e.isLoading=!0,this.jam.folder.search({parentIDs:[e.folder.id],folderIncChildFolderCount:!0,folderIncTrackCount:!0}).then(i=>{let d=i.items.sort((h,ne)=>h.name.localeCompare(ne.name)).map(h=>({folder:h,hasChildren:(h.folderCount??0)>0,level:e.level+1,color:this.typeToColor(h),expanded:this.expandIDs.includes(h.id),isLoading:!1})),v=this.nodes.indexOf(e);v!==-1&&(this.nodes=[...this.nodes.slice(0,v+1),...d,...this.nodes.slice(v+1)]),e.children=d,e.isLoading=!1,t&&t(d)}).catch(i=>{this.notify.error(i)}))}collapseNode(e){if(e.expanded){let t=[];ie(e,i=>t.push(i.folder.id)),this.nodes=this.nodes.filter(i=>!t.includes(i.folder.id)),e.expanded=!1,e.children=void 0,this.expandIDs=this.expandIDs.filter(i=>i!==e.folder.id)}}expandNode(e){if(!e.expanded){if(e.children){let t=this.nodes.indexOf(e);this.nodes=[...this.nodes.slice(0,t+1),...e.children,...this.nodes.slice(t+1)]}else this.loadChildren(e);this.expandIDs.push(e.folder.id),e.expanded=!0}}};r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=F({type:r,selectors:[["app-admin-folder-tree"]],viewQuery:function(t,i){t&1&&R(i.viewport,C,5),t&2&&V()},inputs:{autoSelect:[1,"autoSelect"]},outputs:{selectionChange:"selectionChange"},decls:8,vars:2,consts:()=>{let e;e=$localize`:␟21e3799e2b1bfef3056c82909b88edfbd65ee66c␟1467125554926319902:Refresh Folder Tree`;let t;return t=$localize`:␟3fde556358b58d910adc30abaaff2433f0bb5f6c␟1205037876874222931:Folders`,[t,[1,"actions"],[1,"name"],["title",e,1,"button-on-control",3,"click"],["aria-hidden","true",1,"icon-reload"],["appFocusKeyList","","role","list",1,"tree"],[1,"list-container","list-group",2,"height","100%",3,"itemSize"],[4,"cdkVirtualFor","cdkVirtualForOf"],["appFocusKeyListItem","","role","listitem",1,"node",3,"click","keydown.arrowLeft","keydown.arrowRight","keydown.enter"],[1,"node-toggle",3,"clickenter","title"],[1,"icon-spin","icon-spinner"],[3,"class"],[1,"node-icon",3,"clickenter","title"],[3,"title"],[1,"node-type"]]},template:function(t,i){t&1&&(s(0,"div",1)(1,"span",2),D(2,0),a(),s(3,"button",3),g("click",function(){return i.refresh()}),m(4,"i",4),a()(),s(5,"div",5)(6,"cdk-virtual-scroll-viewport",6),N(7,de,12,20,"ng-container",7),a()()),t&2&&(l(6),u("itemSize",22),l(),u("cdkVirtualForOf",i.nodes))},dependencies:[q,Q,U,C,W,Y,Z,H],styles:["[_nghost-%COMP%]{width:100%;height:100%;display:flex;flex-direction:column}[_nghost-%COMP%]   .actions[_ngcontent-%COMP%]{padding:15px 15px 10px;background-color:var(--background-transparent);color:var(--on-control)}[_nghost-%COMP%]   .actions[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{padding-right:10px;vertical-align:middle;color:var(--on-control-active);font-size:20px;font-weight:100}[_nghost-%COMP%]   .tree[_ngcontent-%COMP%]{margin-top:10px;flex:1}[_nghost-%COMP%]   cdk-virtual-scroll-viewport[_ngcontent-%COMP%]{width:100%;height:100%;min-height:100%;overflow-x:hidden}[_nghost-%COMP%]   cdk-virtual-scroll-viewport[_ngcontent-%COMP%]     .cdk-virtual-scroll-content-wrapper{width:100%}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]{width:100%;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;vertical-align:middle;height:22px;cursor:pointer;-webkit-user-select:none;user-select:none;font-size:.9em}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]   .node-toggle[_ngcontent-%COMP%]{display:inline-block;min-width:20px}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]   .node-type[_ngcontent-%COMP%]{padding-left:5px;font-size:.7em;text-transform:uppercase}[_nghost-%COMP%]   .node.active[_ngcontent-%COMP%]{color:var(--on-control-hover)}"]});let o=r;return o})();export{ve as a};
