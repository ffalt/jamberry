import{b as w}from"./chunk-CERT6F7Z.js";import{G as N}from"./chunk-ZMFSGBQT.js";import{h as $}from"./chunk-B4HPT77T.js";import{$b as P,Cb as _,Db as m,Gb as C,Hb as g,Jd as s,Mb as l,Nb as c,Ob as h,Pc as y,Qc as F,U as v,Vb as M,Xb as S,Xd as I,Za as d,ac as p,fa as u,j as b,ka as k,la as T,mb as H,oc as f,pc as O,qc as x,xa as E}from"./chunk-S3YUDFSI.js";var D=(n,a)=>a.hint.id,A=(n,a)=>a.name;function R(n,a){if(n&1&&(l(0,"div",2),h(1,"i",5),f(2),l(3,"div",6),f(4),c()()),n&2){let t=a.$implicit;d(2),x(" ",t.hint.name," "),d(2),O(t.description)}}function j(n,a){n&1&&(l(0,"div",2),S(1,0),c())}function V(n,a){n&1&&h(0,"i",8)}function L(n,a){if(n&1&&f(0),n&2){let t=p().$implicit;x(" ",t.name," ")}}function G(n,a){if(n&1){let t=M();l(0,"button",7),P("click",function(){let o=k(t).$implicit;return T(o.click())}),_(1,V,1,0,"i",8)(2,L,1,1),c()}if(n&2){let t=a.$implicit;d(),m(t.running?1:2)}}function K(n,a){if(n&1&&(C(0,R,5,2,"div",2,D,!1,j,2,0,"div",2),l(3,"div",3),C(4,G,3,1,"button",4,A),c()),n&2){let t=p(3);g(t.hints),d(4),g(t.solutions)}}function Q(n,a){n&1&&(l(0,"div",2),h(1,"i",8),c())}function z(n,a){n&1&&(l(0,"div",1),_(1,K,6,1)(2,Q,2,0,"div",2),c()),n&2&&(d(),m(a.health?1:2))}function B(n,a){if(n&1&&_(0,z,3,1,"div",1),n&2){let t,e=p();m((t=e.trackHealth())?0:-1,t)}}var it=(()=>{class n{constructor(){this.trackHealth=F(),this.resolvedEvent=y(),this.solutions=[],this.unsubscribe=new b,this.jam=u(I),this.notify=u(N),this.folderService=u(w),this.router=u($)}ngOnChanges(){this.display(this.trackHealth())}ngOnDestroy(){this.unsubscribe.next(),this.unsubscribe.complete()}ngOnInit(){this.folderService.tracksChange.pipe(v(this.unsubscribe)).subscribe(t=>{let e=this.trackHealth();e?.track.id===t.id&&(e.health=[],this.jam.track.health({ids:[e.track.id],healthMedia:!0}).then(o=>{let i=o.find(r=>r.track.id===e.track.id);i?.health?(e.track=i.track,e.health=i.health):e.health=[],e.health.length===0&&this.resolvedEvent.emit(),this.display(e)}).catch(o=>{this.notify.error(o)}))})}fixAll(){for(let t of this.solutions)t.fixable&&!t.running&&t.click()}display(t){this.hints=[],this.solutions=[],t?.health&&(this.hints=t.health.map(e=>{let o=this.describeHint(e,t.track);return{hint:e,description:o}}))}describeTagHint(t,e){let o="";switch(t.id){case s.tagValuesExists:{o=(t.details??[]).map(i=>i.reason.toUpperCase()).join(", ");break}case s.id3v2Garbage:{o=(t.details??[]).map(i=>i.reason).join(", ");break}case s.id3v2Valid:{o=(t.details??[]).map(i=>i.expected&&i.actual?`${i.reason}  (${i.actual} instead of ${i.expected})`:i.reason).join(", ");break}}if(!this.solutions.some(i=>i.name==="Edit Tag")){let i={name:"Edit Tag",click:()=>{this.router.navigate([`/admin/folder/${e.parentID}/tags`]).catch(r=>{console.error(r)})}};this.solutions.push(i)}return o}describeMp3GarbageHint(t,e){let o="";if(t.details&&t.details.length>0&&(o=`${t.details[0].reason} (${t.details[0].actual} bytes)`),!this.solutions.some(i=>i.name==="Fix MP3")){let i={name:"Fix MP3",fixable:!0,click:()=>{i.running||(i.running=!0,this.jam.track.fix({id:e.id,fixID:t.id}).then(r=>{this.folderService.waitForQueueResult("Fixing Track MP3",r,[],[],[e.id])}).catch(r=>{this.notify.error(r)}))}};this.solutions.push(i)}return o}describeMp3ErrorHint(t,e){let o=`Stream Errors: ${(t.details??[]).length}`;if(!this.solutions.some(i=>i.name==="Fix Stream")){let i={name:"Fix Stream",fixable:!0,click:()=>{i.running||(i.running=!0,this.jam.track.fix({id:e.id,fixID:t.id}).then(r=>{this.folderService.waitForQueueResult("Fixing Track Stream",r,[],[],[e.id])}).catch(r=>{this.notify.error(r)}))}};this.solutions.push(i)}return o}describeID3v1Hint(t,e){if(!this.solutions.some(o=>o.name==="Remove ID3v1")){let o={name:"Remove ID3v1",fixable:!0,click:()=>{o.running||(o.running=!0,this.jam.track.fix({id:e.id,fixID:t.id}).then(i=>{this.folderService.waitForQueueResult("Remove ID3v1",i,[],[],[e.id])}).catch(i=>{this.notify.error(i)}))}};this.solutions.push(o)}return""}describeMP3HeaderHint(t,e){let o="";if(t.id===s.mp3HeaderValid&&(o=(t.details??[]).map(i=>i.expected&&i.actual?`${i.reason}  (${i.actual} instead of ${i.expected})`:i.reason).join(", ")),!this.solutions.some(i=>i.name==="Fix Header")){let i={name:"Fix Header",fixable:!0,click:()=>{i.running||(i.running=!0,this.jam.track.fix({id:e.id,fixID:t.id}).then(r=>{this.folderService.waitForQueueResult("Fixing Track Header",r,[],[],[e.id])}).catch(r=>{this.notify.error(r)}))}};this.solutions.push(i)}return o}describeHint(t,e){switch(t.id){case s.tagValuesExists:case s.id3v2Garbage:case s.id3v2Exists:case s.id3v2Valid:return this.describeTagHint(t,e);case s.mp3Garbage:return this.describeMp3GarbageHint(t,e);case s.mp3MediaValid:return this.describeMp3ErrorHint(t,e);case s.id3v2NoId3v1:return this.describeID3v1Hint(t,e);case s.mp3HeaderExists:case s.mp3HeaderValid:return this.describeMP3HeaderHint(t,e);default:break}return""}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=H({type:n,selectors:[["app-track-health"]],inputs:{trackHealth:[1,"trackHealth"]},outputs:{resolvedEvent:"resolvedEvent"},features:[E],decls:1,vars:1,consts:()=>{let t;return t=$localize`:␟baa5a59fd701bf37b30140cf2080f8987db6c2e9␟4786331182153457864:No Hints`,[t,[1,"hints"],[1,"hint"],[1,"solutions"],[1,"button-on-background"],[1,"icon-warning"],[1,"details"],[1,"button-on-background",3,"click"],[1,"icon-spin","icon-spinner"]]},template:function(e,o){e&1&&_(0,B,1,1),e&2&&m(o.hints?0:-1)},styles:["[_nghost-%COMP%]{height:100%;width:100%;overflow-y:auto;overflow-x:auto;display:block}[_nghost-%COMP%]   .icon-warning[_ngcontent-%COMP%]{color:var(--accent)}[_nghost-%COMP%]   .details[_ngcontent-%COMP%]{padding-left:28px;font-size:.8em;display:block;padding-top:5px}[_nghost-%COMP%]   .hint[_ngcontent-%COMP%]{padding-bottom:15px}[_nghost-%COMP%]   .solutions[_ngcontent-%COMP%]{padding-bottom:15px}[_nghost-%COMP%]   .solutions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-right:5px}[_nghost-%COMP%]   .detail[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{text-transform:uppercase;letter-spacing:1.25px;font-size:11px;min-width:80px;margin-right:10px;display:inline-block}"]})}}return n})();export{it as a};
