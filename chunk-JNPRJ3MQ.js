import{a as m}from"./chunk-24DMSAFT.js";import{G as a}from"./chunk-ZVKVGF76.js";import{$d as p,da as d,ia as h,ub as f}from"./chunk-H2EXZDP6.js";var u=(function(r){return r[r.fsnRefresh=0]="fsnRefresh",r[r.fsnRefreshChilds=1]="fsnRefreshChilds",r})(u||{}),R=(()=>{let s=class s{constructor(){this.foldersChange=new f,this.tracksChange=new f,this.queue=[],this.jam=h(p),this.notify=h(a)}notifyTrackChange(e){this.tracksChange.emit({id:e})}notifyFolderChange(e,t){this.foldersChange.emit({id:e,mode:t})}waitForQueueResult(e,t,n,i,c){let o=this.queue.find(g=>g.id===t.id);if(!o&&this.current&&this.current.id===t.id&&(o=this.current),o?.notifyAfter)return this.appendToExistingWaiter(o,n,i,c),o.notifyAfter;let l=new f;return this.queue.push({title:e,id:t.id,item:t,folderIDs:n,refreshChildsFolderIDs:i,trackIDs:c,count:1,notifyAfter:l}),this.nextPoll(),l}appendToExistingWaiter(e,t,n,i){this.appendIds(e,"folderIDs",t),this.appendIds(e,"refreshChildsFolderIDs",n),this.appendIds(e,"trackIDs",i),e.count++}appendIds(e,t,n){if(n){e[t]=e[t]??[];for(let i of n)e[t].includes(i)||e[t].push(i)}}nextPoll(){this.current||(this.current=this.queue.shift(),this.current&&new m((t,n)=>{this.jam.admin.queueId({id:t.id}).then(i=>{if(t.item=i,i.error||i.done!==void 0){i.error&&this.notify.error(new Error(i.error)),this.pollEnd(t,i),n(!1);return}n(!0)}).catch(i=>{console.error("error while polling admin change queue status",i),this.pollEnd(t),n(!1)})}).poll(this.current,!0))}pollEnd(e,t){for(let n of e.folderIDs??[])this.notifyFolderChange(n,u.fsnRefresh);for(let n of e.refreshChildsFolderIDs??[])this.notifyFolderChange(n,u.fsnRefreshChilds);for(let n of e.trackIDs??[])this.notifyTrackChange(n);e.notifyAfter&&(e.notifyAfter.emit(t),e.notifyAfter.complete(),e.notifyAfter=void 0),this.current=void 0,this.nextPoll()}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=d({token:s,factory:s.\u0275fac,providedIn:"root"});let r=s;return r})();export{u as a,R as b};
