import{b as d}from"./chunk-CERT6F7Z.js";import{a as p}from"./chunk-24DMSAFT.js";import{a as l}from"./chunk-4LEAF22C.js";import{G as u}from"./chunk-ZMFSGBQT.js";import{U as r,Xd as m,aa as c,e as n,fa as i,j as a,ra as f}from"./chunk-S3YUDFSI.js";var F=(()=>{class s{constructor(){this.rootsChange=new f,this.rootChange=new l,this.unsubscribe=new a,this.jam=i(m),this.notify=i(u),this.folderService=i(d),this.rootPoll=new p((t,e)=>{this.jam.root.status({id:t.id}).then(o=>{if(!(this.rootsChange.observed||this.rootChange.observed(t.id))){e(!1);return}o.scanning?e(!0):(t.status=o,e(!1))}).catch(o=>{console.error("error while polling root scan status",o),e(!1)})}),this.roots=[]}ngOnDestroy(){this.unsubscribe.next(),this.unsubscribe.complete()}applyDialogRoot(t){return n(this,null,function*(){if(t.root){let e=t.root.id,o=yield this.jam.root.update({id:e,name:t.name,path:t.path,strategy:t.strategy});this.folderService.waitForQueueResult("Updating Root",o,[]).pipe(r(this.unsubscribe)).subscribe(()=>{this.notify.success("Root updated"),this.refreshRoot(e)})}else{let e=yield this.jam.root.create({name:t.name,path:t.path,strategy:t.strategy});this.folderService.waitForQueueResult("Creating Root",e,[]).pipe(r(this.unsubscribe)).subscribe(()=>{this.notify.success("Root created"),this.refreshRoots()})}})}rescanRoot(t){this.jam.root.refresh({id:t.id}).then(()=>{this.refreshRoot(t.id)}).catch(e=>{this.notify.error(e)})}refreshRootMeta(t){this.jam.root.refreshMeta({id:t.id}).then(()=>{this.refreshRoot(t.id)}).catch(e=>{this.notify.error(e)})}rescanRoots(){this.jam.root.refresh({}).then(()=>{this.refreshRoots()}).catch(t=>{this.notify.error(t)})}removeRoot(t){this.jam.root.remove({id:t.id}).then(e=>{this.folderService.waitForQueueResult("Removing Root",e,[]).pipe(r(this.unsubscribe)).subscribe(()=>{this.roots=this.roots.filter(o=>o.id!==t.id),this.rootChange.emit(t.id),this.notify.success("Root removed"),this.refreshRoots()})}).catch(e=>{this.notify.error(e)})}refreshRoot(t){this.jam.root.id({id:t}).then(e=>{let o=this.roots.findIndex(h=>h.id===t);o===-1?this.roots.push(e):this.roots[o]=e,this.rootChange.emit(t,e),this.rootsChange.emit(this.roots),e.status.scanning&&this.rootPoll.poll(e)}).catch(e=>{this.notify.error(e)})}refreshRoots(){this.jam.root.search({}).then(t=>{this.roots=t.items;for(let e of this.roots)e.status.scanning&&this.rootPoll.poll(e);this.rootsChange.emit(this.roots)}).catch(t=>{this.notify.error(t)})}static{this.\u0275fac=function(e){return new(e||s)}}static{this.\u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{F as a};
