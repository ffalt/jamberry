import{a as Z,b as ee}from"./chunk-MWWVWNOX.js";import{a as H}from"./chunk-JP4K5MFN.js";import{a as J}from"./chunk-6WISUSLE.js";import{a as W,b as Y}from"./chunk-RJHPSDKR.js";import{G as q,j as X,m as g,n as Q,p as U}from"./chunk-3LOKQP2Q.js";import{$b as m,Db as v,Eb as T,Ec as M,Hc as y,Jb as h,Kb as d,Lb as s,Mb as u,Oc as z,Pc as B,Qb as N,Qc as K,Rb as b,Rd as p,U as S,Wb as L,Wd as G,Yb as I,_a as r,bc as l,fa as C,j as k,jc as D,ka as c,kc as R,la as a,mc as w,nb as F,nc as V,oc as E,pc as O,qc as $,rc as A,sb as P,yc as j}from"./chunk-XLNNDSL4.js";function ne(o,_){o&1&&u(0,"i",10)}function oe(o,_){if(o&1&&(u(0,"i"),M(1,"stringToggle")),o&2){let e=l().$implicit;E(y(1,2,e.expanded,"icon-minus","icon-plus"))}}function re(o,_){if(o&1){let e=L();N(0),d(1,"div",8),m("click",function(){let i=c(e).$implicit,n=l();return a(n.selectNode(i))})("keydown.arrowLeft",function(){let i=c(e).$implicit,n=l();return a(n.toggleNode(i))})("keydown.arrowRight",function(){let i=c(e).$implicit,n=l();return a(n.toggleNode(i))})("keydown.enter",function(){let i=c(e).$implicit,n=l();return a(n.selectNode(i))}),d(2,"span",9),m("clickenter",function(){let i=c(e).$implicit,n=l();return a(n.toggleNode(i))}),v(3,ne,1,0,"i",10),v(4,oe,2,6,"i",11),s(),d(5,"span",12),m("clickenter",function(){let i=c(e).$implicit,n=l();return a(n.toggleNode(i))}),u(6,"i"),M(7,"stringToggle"),s(),d(8,"span",13),O(9),s(),d(10,"span",14),O(11),s()(),b()}if(o&2){let e=_.$implicit,t=l();r(),w("padding-left",e.level*12,"px"),V("active",e===t.selected),r(),h("title",j("Subfolders: ",e.folder.folderCount)),r(),T(e.isLoading?3:-1),r(),T(!e.isLoading&&e.hasChildren?4:-1),r(),w("color",e.color),h("title",e.folder.type),r(),E(y(7,16,e.expanded,"icon-folder-open","icon-folder")),r(2),h("title",e.folder.name),r(),$(e.folder.name),r(2),A("| ",e.folder.type)}}function te(o,_){if(o.children)for(let e of o.children)_(e),te(e,_)}var xe=(()=>{class o{constructor(){this.autoSelect=B(!1),this.selectionChange=z(),this.nodes=[],this.expandIDs=[],this.viewport=K(g),this.unsubscribe=new k,this.jam=C(G),this.notify=C(q),this.folderService=C(ee)}ngOnInit(){this.folderService.foldersChange.pipe(S(this.unsubscribe)).subscribe(e=>{let t=this.nodes.find(i=>i.folder.id===e.id);t&&this.jam.folder.id({id:e.id,folderIncTrackCount:!0,folderIncChildFolderCount:!0}).then(i=>{t.folder=i,e.mode===Z.fsnRefreshChilds&&t.expanded&&(this.collapseNode(t),t.hasChildren=(i.folderCount??0)>0,t.children=void 0,t.isLoading=!1,t.hasChildren&&(t.expanded=!0,this.checkLoadExpanded(t)))}).catch(i=>{console.error(i)})})}ngOnDestroy(){this.unsubscribe.next(),this.unsubscribe.complete()}selectNode(e){this.selectionChange.emit(e.folder),this.autoSelect()&&(this.selected=e)}toggleNode(e){e.expanded?this.collapseNode(e):this.expandNode(e)}refresh(){this.jam.auth.isLoggedIn()&&this.jam.folder.search({level:0,folderIncChildFolderCount:!0,folderIncTrackCount:!0}).then(e=>{this.nodes=e.items.map(t=>({folder:t,hasChildren:(t.folderCount??0)>0,level:0,color:this.typeToColor(t),expanded:this.expandIDs.includes(t.id),isLoading:!1}));for(let t of this.nodes)this.checkLoadExpanded(t)}).catch(e=>{this.notify.error(e)})}typeToColor(e){switch(e.type){case p.unknown:return"#ff9fAA";case p.artist:return"#6f806e";case p.collection:return"#adbced";case p.album:return"#bdbd9c";case p.multialbum:return"#bdaaae";case p.extras:return"#bdbdbd";default:return""}}onFolderUpdate(e){let t=this.nodes.find(i=>i.folder.id===e.id);t&&(t.folder=e)}selectFolderByID(e){let t=this.nodes.find(i=>i.folder.id===e);t?this.selected=t:this.jam.folder.id({id:e,folderIncParents:!0}).then(i=>{if(i.parents){for(let n of i.parents)this.expandIDs.includes(n.id)||this.expandIDs.push(n.id);for(let n of this.nodes)n.expanded=this.expandIDs.includes(n.folder.id),this.checkLoadExpanded(n,e)}}).catch(i=>{this.notify.error(i)})}checkLoadExpanded(e,t){if(e.expanded&&!e.isLoading&&this.loadChildren(e,i=>{for(let n of i)this.checkLoadExpanded(n,t)}),e.folder.id===t){this.selected=e;let i=this.viewport();i&&i.scrollToIndex(this.nodes.indexOf(e))}}loadChildren(e,t){e.isLoading||(e.isLoading=!0,this.jam.folder.search({parentIDs:[e.folder.id],folderIncChildFolderCount:!0,folderIncTrackCount:!0}).then(i=>{let n=i.items.toSorted((f,ie)=>f.name.localeCompare(ie.name)).map(f=>({folder:f,hasChildren:(f.folderCount??0)>0,level:e.level+1,color:this.typeToColor(f),expanded:this.expandIDs.includes(f.id),isLoading:!1})),x=this.nodes.indexOf(e);x!==-1&&(this.nodes=[...this.nodes.slice(0,x+1),...n,...this.nodes.slice(x+1)]),e.children=n,e.isLoading=!1,t&&t(n)}).catch(i=>{this.notify.error(i)}))}collapseNode(e){if(e.expanded){let t=[];te(e,i=>t.push(i.folder.id)),this.nodes=this.nodes.filter(i=>!t.includes(i.folder.id)),e.expanded=!1,e.children=void 0,this.expandIDs=this.expandIDs.filter(i=>i!==e.folder.id)}}expandNode(e){if(!e.expanded){if(e.children){let t=this.nodes.indexOf(e);this.nodes=[...this.nodes.slice(0,t+1),...e.children,...this.nodes.slice(t+1)]}else this.loadChildren(e);this.expandIDs.push(e.folder.id),e.expanded=!0}}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=F({type:o,selectors:[["app-admin-folder-tree"]],viewQuery:function(t,i){t&1&&D(i.viewport,g,5),t&2&&R()},inputs:{autoSelect:[1,"autoSelect"]},outputs:{selectionChange:"selectionChange"},decls:8,vars:2,consts:()=>{let e;e=$localize`:␟21e3799e2b1bfef3056c82909b88edfbd65ee66c␟1467125554926319902:Refresh Folder Tree`;let t;return t=$localize`:␟3fde556358b58d910adc30abaaff2433f0bb5f6c␟1205037876874222931:Folders`,[t,[1,"actions"],[1,"name"],["title",e,1,"button-on-control",3,"click"],["aria-hidden","true",1,"icon-reload"],["appFocusKeyList","","role","list",1,"tree"],[1,"list-container","list-group",2,"height","100%",3,"itemSize"],[4,"cdkVirtualFor","cdkVirtualForOf"],["appFocusKeyListItem","","role","listitem",1,"node",3,"click","keydown.arrowLeft","keydown.arrowRight","keydown.enter"],[1,"node-toggle",3,"clickenter","title"],[1,"icon-spin","icon-spinner"],[3,"class"],[1,"node-icon",3,"clickenter","title"],[3,"title"],[1,"node-type"]]},template:function(t,i){t&1&&(d(0,"div",1)(1,"span",2),I(2,0),s(),d(3,"button",3),m("click",function(){return i.refresh()}),u(4,"i",4),s()(),d(5,"div",5)(6,"cdk-virtual-scroll-viewport",6),P(7,re,12,20,"ng-container",7),s()()),t&2&&(r(6),h("itemSize",22),r(),h("cdkVirtualForOf",i.nodes))},dependencies:[U,X,Q,g,H,W,Y,J],styles:["[_nghost-%COMP%]{width:100%;height:100%;display:flex;flex-direction:column}[_nghost-%COMP%]   .actions[_ngcontent-%COMP%]{padding:15px 15px 10px;background-color:var(--background-transparent);color:var(--on-control)}[_nghost-%COMP%]   .actions[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{padding-right:10px;vertical-align:middle;color:var(--on-control-active);font-size:20px;font-weight:100}[_nghost-%COMP%]   .tree[_ngcontent-%COMP%]{margin-top:10px;flex:1}[_nghost-%COMP%]   cdk-virtual-scroll-viewport[_ngcontent-%COMP%]{width:100%;height:100%;min-height:100%;overflow-x:hidden}[_nghost-%COMP%]   cdk-virtual-scroll-viewport[_ngcontent-%COMP%]     .cdk-virtual-scroll-content-wrapper{width:100%}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]{width:100%;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;vertical-align:middle;height:22px;cursor:pointer;-webkit-user-select:none;user-select:none;font-size:.9em}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]   .node-toggle[_ngcontent-%COMP%]{display:inline-block;min-width:20px}[_nghost-%COMP%]   .node[_ngcontent-%COMP%]   .node-type[_ngcontent-%COMP%]{padding-left:5px;font-size:.7em;text-transform:uppercase}[_nghost-%COMP%]   .node.active[_ngcontent-%COMP%]{color:var(--on-control-hover)}"]})}}return o})();export{xe as a};
